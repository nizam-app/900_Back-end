{
  "info": {
    "name": "FSM System API - Complete Collection",
    "description": "Updated test collection with OTP-based authentication, location services, and all new features (Nov 2025)\n\nðŸ“ TEST CREDENTIALS (from seed data):\nâ€¢ Admin: 1111111111\nâ€¢ Dispatcher: 2222222222\nâ€¢ Call Center: 3333333333\nâ€¢ Internal Tech: 4444444444\nâ€¢ Freelancer 1: 5555555555\nâ€¢ Freelancer 2: 6666666666\nâ€¢ Customer 1: 9999999999\nâ€¢ Customer 2: 8888888888\nâ€¢ Customer 3: 7777777777\nâ€¢ All passwords: password123\n\nðŸ” NEW REGISTRATION FLOW (3 Steps):\n1. Send OTP to phone â†’ GET OTP code\n2. Verify OTP â†’ GET tempToken\n3. Set password with tempToken â†’ GET auth token\n\nðŸ”‘ LOGIN FLOW (Simple):\nâ€¢ Phone + Password only (no OTP needed)\n\nâš ï¸ OTP CODES: All OTPs returned in response (for testing)\n\nðŸŒ Base URL: http://localhost:4000/api",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:4000/api"
    },
    {
      "key": "auth_token",
      "value": ""
    },
    {
      "key": "temp_token",
      "value": ""
    }
  ],
  "item": [
    {
      "name": "Authentication",
      "item": [
        {
          "name": "1. Send OTP for Registration",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"0123456789\",\n  \"type\": \"REGISTRATION\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/otp/send",
              "host": ["{{base_url}}"],
              "path": ["otp", "send"]
            },
            "description": "Step 1: Send OTP to phone number for new registration"
          }
        },
        {
          "name": "2. Verify OTP",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"0123456789\",\n  \"code\": \"123456\",\n  \"type\": \"REGISTRATION\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/otp/verify",
              "host": ["{{base_url}}"],
              "path": ["otp", "verify"]
            },
            "description": "Step 2: Verify OTP code. Returns tempToken for password setup."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('temp_token', response.tempToken);",
                  "    console.log('Temp token saved:', response.tempToken);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "3. Set Password (After OTP)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"0123456789\",\n  \"password\": \"SecurePass123\",\n  \"name\": \"John Doe\",\n  \"email\": \"john@example.com\",\n  \"tempToken\": \"{{temp_token}}\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/auth/set-password",
              "host": ["{{base_url}}"],
              "path": ["auth", "set-password"]
            },
            "description": "Step 3: Set password using tempToken from OTP verification. Creates account and logs in."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('auth_token', response.token);",
                  "    console.log('Token saved:', response.token);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "4. Login with Phone + Password",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"9999999999\",\n  \"password\": \"password123\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/auth/login",
              "host": ["{{base_url}}"],
              "path": ["auth", "login"]
            },
            "description": "Step 4: Login with phone and password (no OTP needed after registration)"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('auth_token', response.token);",
                  "    console.log('Token saved:', response.token);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin - 1. Send OTP",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"1111111111\",\n  \"type\": \"LOGIN\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/otp/send",
              "host": ["{{base_url}}"],
              "path": ["otp", "send"]
            }
          }
        },
        {
          "name": "Admin - 2. Login with Password",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"1111111111\",\n  \"password\": \"password123\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/auth/login",
              "host": ["{{base_url}}"],
              "path": ["auth", "login"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('auth_token', response.token);",
                  "    console.log('Admin token saved:', response.token);",
                  "}"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Location Services",
      "item": [
        {
          "name": "Update Technician Location",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"latitude\": 40.7128,\n  \"longitude\": -74.0060\n}"
            },
            "url": {
              "raw": "{{base_url}}/location/update",
              "host": ["{{base_url}}"],
              "path": ["location", "update"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has success property', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('success', true);",
                  "});",
                  "",
                  "pm.test('Response includes location name', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('locationName');",
                  "    console.log('Location Name:', response.locationName);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Nearby Technicians",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/location/nearby?latitude=40.7128&longitude=-74.0060&radius=10&limit=10",
              "host": ["{{base_url}}"],
              "path": ["location", "nearby"],
              "query": [
                {
                  "key": "latitude",
                  "value": "40.7128",
                  "description": "Customer/Work Order latitude"
                },
                {
                  "key": "longitude",
                  "value": "-74.0060",
                  "description": "Customer/Work Order longitude"
                },
                {
                  "key": "radius",
                  "value": "10",
                  "description": "Search radius in kilometers"
                },
                {
                  "key": "limit",
                  "value": "10",
                  "description": "Maximum number of technicians to return"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has technicians array', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('technicians');",
                  "    pm.expect(response.technicians).to.be.an('array');",
                  "});",
                  "",
                  "pm.test('Each technician has distance and location name', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.technicians.length > 0) {",
                  "        response.technicians.forEach(tech => {",
                  "            pm.expect(tech).to.have.property('distance');",
                  "            pm.expect(tech).to.have.property('locationName');",
                  "            pm.expect(tech).to.have.property('estimatedArrival');",
                  "            console.log(`${tech.name}: ${tech.distance}km away at ${tech.locationName}`);",
                  "        });",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Location History",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/location/history/1?startDate=2024-11-01&endDate=2024-11-19&limit=50",
              "host": ["{{base_url}}"],
              "path": ["location", "history", "1"],
              "query": [
                {
                  "key": "startDate",
                  "value": "2024-11-01",
                  "description": "Start date (YYYY-MM-DD)"
                },
                {
                  "key": "endDate",
                  "value": "2024-11-19",
                  "description": "End date (YYYY-MM-DD)"
                },
                {
                  "key": "limit",
                  "value": "50",
                  "description": "Maximum number of location records"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has location history', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('success', true);",
                  "    pm.expect(response).to.have.property('locations');",
                  "    console.log('Location history entries:', response.locations.length);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Test Different Locations",
      "item": [
        {
          "name": "Update Location - New York",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"latitude\": 40.7128,\n  \"longitude\": -74.0060\n}"
            },
            "url": {
              "raw": "{{base_url}}/location/update",
              "host": ["{{base_url}}"],
              "path": ["location", "update"]
            }
          }
        },
        {
          "name": "Update Location - Los Angeles",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"latitude\": 34.0522,\n  \"longitude\": -118.2437\n}"
            },
            "url": {
              "raw": "{{base_url}}/location/update",
              "host": ["{{base_url}}"],
              "path": ["location", "update"]
            }
          }
        },
        {
          "name": "Update Location - London",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"latitude\": 51.5074,\n  \"longitude\": -0.1278\n}"
            },
            "url": {
              "raw": "{{base_url}}/location/update",
              "host": ["{{base_url}}"],
              "path": ["location", "update"]
            }
          }
        },
        {
          "name": "Get Nearby - Times Square Area",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/location/nearby?latitude=40.7580&longitude=-73.9855&radius=5&limit=5",
              "host": ["{{base_url}}"],
              "path": ["location", "nearby"],
              "query": [
                {
                  "key": "latitude",
                  "value": "40.7580"
                },
                {
                  "key": "longitude",
                  "value": "-73.9855"
                },
                {
                  "key": "radius",
                  "value": "5"
                },
                {
                  "key": "limit",
                  "value": "5"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "Service Requests (SRs)",
      "item": [
        {
          "name": "Create SR - Authenticated Customer",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}",
                "description": "Required for authenticated users"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"9999999999\",\n  \"address\": \"123 Main St, New York\",\n  \"latitude\": 40.7128,\n  \"longitude\": -74.0060,\n  \"categoryId\": 1,\n  \"subserviceId\": 2,\n  \"serviceId\": 3,\n  \"description\": \"AC not cooling properly\",\n  \"priority\": \"HIGH\",\n  \"preferredDate\": \"2025-12-05T10:00:00Z\",\n  \"preferredTime\": \"Morning\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/srs",
              "host": ["{{base_url}}"],
              "path": ["srs"]
            },
            "description": "Create SR as authenticated customer. isGuest will be FALSE. Uses phone from token."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('SR created with isGuest = false', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('isGuest', false);",
                  "    pm.expect(response.source).to.equal('CUSTOMER_APP');",
                  "    console.log('isGuest:', response.isGuest);",
                  "    console.log('source:', response.source);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Create SR - Guest (No Auth)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"0987654321\",\n  \"name\": \"Guest Customer\",\n  \"email\": \"guest@example.com\",\n  \"address\": \"456 Oak Ave, Brooklyn\",\n  \"latitude\": 40.6782,\n  \"longitude\": -73.9442,\n  \"categoryId\": 1,\n  \"subserviceId\": 1,\n  \"serviceId\": 1,\n  \"description\": \"Plumbing issue\",\n  \"priority\": \"MEDIUM\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/srs",
              "host": ["{{base_url}}"],
              "path": ["srs"]
            },
            "description": "Create SR as guest (no Authorization header). isGuest will be TRUE. Creates temporary user account."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('SR created with isGuest = true', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('isGuest', true);",
                  "    pm.expect(response.source).to.equal('WEB_PORTAL');",
                  "    console.log('isGuest:', response.isGuest);",
                  "    console.log('source:', response.source);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get My Service Requests",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/srs",
              "host": ["{{base_url}}"],
              "path": ["srs"]
            },
            "description": "Get SRs for authenticated customer. ONLY shows SRs created by this customer (filters by customerId)."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Response includes SR list', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.be.an('array');",
                  "});",
                  "",
                  "pm.test('Customer only sees own SRs', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.length > 0) {",
                  "        // All SRs should belong to the authenticated user",
                  "        response.forEach(sr => {",
                  "            pm.expect(sr.customer).to.exist;",
                  "            console.log('SR customer:', sr.customer.phone);",
                  "        });",
                  "    }",
                  "});",
                  "",
                  "pm.test('Each SR has user-friendly status', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.length > 0) {",
                  "        const validStatuses = ['PENDING_APPROVAL', 'ACTIVE', 'COMPLETED', 'CANCELLED', 'REJECTED'];",
                  "        response.forEach(sr => {",
                  "            pm.expect(sr).to.have.property('status');",
                  "            pm.expect(validStatuses).to.include(sr.status);",
                  "        });",
                  "    }",
                  "});",
                  "",
                  "pm.test('Each SR has readableStatus', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.length > 0) {",
                  "        response.forEach(sr => {",
                  "            pm.expect(sr).to.have.property('readableStatus');",
                  "            console.log('SR', sr.srNumber, 'readableStatus:', sr.readableStatus);",
                  "        });",
                  "    }",
                  "});",
                  "",
                  "pm.test('Each SR includes scheduledAt', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.length > 0) {",
                  "        response.forEach(sr => {",
                  "            pm.expect(sr).to.have.property('scheduledAt');",
                  "        });",
                  "    }",
                  "});",
                  "",
                  "pm.test('Each SR includes assignedTechnician details', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.length > 0) {",
                  "        response.forEach(sr => {",
                  "            pm.expect(sr).to.have.property('assignedTechnician');",
                  "            if (sr.assignedTechnician) {",
                  "                pm.expect(sr.assignedTechnician).to.have.property('id');",
                  "                pm.expect(sr.assignedTechnician).to.have.property('name');",
                  "                pm.expect(sr.assignedTechnician).to.have.property('phone');",
                  "            }",
                  "        });",
                  "    }",
                  "});",
                  "",
                  "pm.test('Completed SRs include payment summary', function () {",
                  "    const response = pm.response.json();",
                  "    const completedSRs = response.filter(sr => sr.status === 'COMPLETED');",
                  "    completedSRs.forEach(sr => {",
                  "        if (sr.paymentSummary) {",
                  "            pm.expect(sr.paymentSummary).to.have.property('totalAmount');",
                  "            pm.expect(sr.paymentSummary).to.have.property('paidAmount');",
                  "            pm.expect(sr.paymentSummary).to.have.property('paymentStatus');",
                  "        }",
                  "    });",
                  "});",
                  "",
                  "pm.test('Completed SRs may include technician rating', function () {",
                  "    const response = pm.response.json();",
                  "    const completedSRs = response.filter(sr => sr.status === 'COMPLETED');",
                  "    completedSRs.forEach(sr => {",
                  "        pm.expect(sr).to.have.property('technicianRating');",
                  "    });",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get My SRs (Dedicated /my Endpoint)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/srs/my",
              "host": ["{{base_url}}"],
              "path": ["srs", "my"]
            },
            "description": "Dedicated /my endpoint for customers. Returns only logged-in user's SRs with readable status descriptions."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Response includes SR list', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.be.an('array');",
                  "});",
                  "",
                  "pm.test('Each SR has status field', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.length > 0) {",
                  "        const validStatuses = ['PENDING_APPROVAL', 'ACTIVE', 'COMPLETED', 'CANCELLED', 'REJECTED'];",
                  "        response.forEach(sr => {",
                  "            pm.expect(sr).to.have.property('status');",
                  "            pm.expect(validStatuses).to.include(sr.status);",
                  "        });",
                  "    }",
                  "});",
                  "",
                  "pm.test('Each SR has readableStatus field', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.length > 0) {",
                  "        const validReadableStatuses = [",
                  "            'Pending Approval',",
                  "            'Assigned to Technician',",
                  "            'Technician On The Way',",
                  "            'Work In Progress',",
                  "            'Awaiting Payment',",
                  "            'Completed',",
                  "            'Cancelled',",
                  "            'Rejected',",
                  "            'Active'",
                  "        ];",
                  "        response.forEach(sr => {",
                  "            pm.expect(sr).to.have.property('readableStatus');",
                  "            pm.expect(validReadableStatuses).to.include(sr.readableStatus);",
                  "            console.log('SR', sr.srNumber, '- Status:', sr.status, '- Readable:', sr.readableStatus);",
                  "        });",
                  "    }",
                  "});",
                  "",
                  "pm.test('Each SR includes required fields', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.length > 0) {",
                  "        response.forEach(sr => {",
                  "            pm.expect(sr).to.have.property('srId');",
                  "            pm.expect(sr).to.have.property('srNumber');",
                  "            pm.expect(sr).to.have.property('description');",
                  "            pm.expect(sr).to.have.property('priority');",
                  "            pm.expect(sr).to.have.property('address');",
                  "            pm.expect(sr).to.have.property('category');",
                  "            pm.expect(sr).to.have.property('scheduledAt');",
                  "            pm.expect(sr).to.have.property('assignedTechnician');",
                  "        });",
                  "    }",
                  "});",
                  "",
                  "pm.test('ACTIVE SRs have detailed readable status', function () {",
                  "    const response = pm.response.json();",
                  "    const activeSRs = response.filter(sr => sr.status === 'ACTIVE');",
                  "    if (activeSRs.length > 0) {",
                  "        const activeReadableStatuses = [",
                  "            'Assigned to Technician',",
                  "            'Technician On The Way',",
                  "            'Work In Progress',",
                  "            'Awaiting Payment',",
                  "            'Active'",
                  "        ];",
                  "        activeSRs.forEach(sr => {",
                  "            pm.expect(activeReadableStatuses).to.include(sr.readableStatus);",
                  "        });",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get My SRs - Filter by Status",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/srs/my?status=ACTIVE",
              "host": ["{{base_url}}"],
              "path": ["srs", "my"],
              "query": [
                {
                  "key": "status",
                  "value": "ACTIVE",
                  "description": "Filter by: PENDING_APPROVAL, ACTIVE, COMPLETED, CANCELLED, REJECTED"
                }
              ]
            },
            "description": "Filter SRs by user-friendly status: PENDING_APPROVAL, ACTIVE, COMPLETED, CANCELLED, REJECTED"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('All returned SRs match the filter status', function () {",
                  "    const response = pm.response.json();",
                  "    const requestedStatus = pm.request.url.query.get('status');",
                  "    if (response.length > 0 && requestedStatus) {",
                  "        response.forEach(sr => {",
                  "            pm.expect(sr.status).to.equal(requestedStatus);",
                  "        });",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get SR Details by ID",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/srs/1",
              "host": ["{{base_url}}"],
              "path": ["srs", "1"]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('SR details include scheduledAt', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('scheduledAt');",
                  "});",
                  "",
                  "pm.test('SR details include assignedTechnician object', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('assignedTechnician');",
                  "    if (response.assignedTechnician) {",
                  "        pm.expect(response.assignedTechnician).to.have.property('id');",
                  "        pm.expect(response.assignedTechnician).to.have.property('name');",
                  "        pm.expect(response.assignedTechnician).to.have.property('phone');",
                  "        pm.expect(response.assignedTechnician).to.have.property('email');",
                  "    }",
                  "});",
                  "",
                  "pm.test('SR details include payment summary with details', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('paymentSummary');",
                  "    if (response.paymentSummary) {",
                  "        pm.expect(response.paymentSummary).to.have.property('totalAmount');",
                  "        pm.expect(response.paymentSummary).to.have.property('paidAmount');",
                  "        pm.expect(response.paymentSummary).to.have.property('pendingAmount');",
                  "        pm.expect(response.paymentSummary).to.have.property('paymentStatus');",
                  "        pm.expect(response.paymentSummary).to.have.property('payments');",
                  "    }",
                  "});",
                  "",
                  "pm.test('SR details include technician rating details', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('technicianRating');",
                  "    if (response.technicianRating) {",
                  "        pm.expect(response.technicianRating).to.have.property('rating');",
                  "        pm.expect(response.technicianRating).to.have.property('comment');",
                  "        pm.expect(response.technicianRating).to.have.property('createdAt');",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Rebook Completed Service",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"preferredDate\": \"2025-12-10T14:00:00Z\",\n  \"preferredTime\": \"Afternoon\",\n  \"description\": \"Same issue - need service again\",\n  \"address\": \"123 Main St, New York\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/srs/1/rebook",
              "host": ["{{base_url}}"],
              "path": ["srs", "1", "rebook"]
            },
            "description": "Rebook a completed service with NEW date/time. Customer can customize: preferredDate, preferredTime, description, address. Original service details (category, subservice) are preserved."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Rebook successful - returns 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Response includes new SR', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('sr');",
                  "    pm.expect(response).to.have.property('message', 'Service rebooked successfully');",
                  "});",
                  "",
                  "pm.test('New SR has correct initial status', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.sr.status).to.equal('NEW');",
                  "});",
                  "",
                  "pm.test('New SR has unique srNumber', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.sr).to.have.property('srNumber');",
                  "    pm.expect(response.sr.srNumber).to.include('SR-');",
                  "});",
                  "",
                  "pm.test('New SR preserves service details', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.sr).to.have.property('category');",
                  "    pm.expect(response.sr).to.have.property('subservice');",
                  "    pm.expect(response.sr.customerId).to.exist;",
                  "});",
                  "",
                  "pm.test('New SR uses provided date/time', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.sr.preferredDate).to.exist;",
                  "    pm.expect(response.sr.preferredTime).to.equal('Afternoon');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Book Again (Simple Copy)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": ""
            },
            "url": {
              "raw": "{{base_url}}/srs/1/book-again",
              "host": ["{{base_url}}"],
              "path": ["srs", "1", "book-again"]
            },
            "description": "Simplified booking - copies the entire SR with same details. No body parameters needed. Resets: statusâ†’NEW, preferredDateâ†’null, preferredTimeâ†’null, assignments cleared. Customer schedules later."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Book Again successful - returns 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Response includes new SR', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('sr');",
                  "    pm.expect(response.message).to.include('booked again successfully');",
                  "});",
                  "",
                  "pm.test('New SR has NEW status', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.sr.status).to.be.oneOf(['NEW', 'PENDING_APPROVAL']);",
                  "});",
                  "",
                  "pm.test('New SR has unique srNumber', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.sr.srNumber).to.exist;",
                  "    pm.expect(response.sr.srNumber).to.include('SR-');",
                  "});",
                  "",
                  "pm.test('Date/time are reset (null)', function () {",
                  "    const response = pm.response.json();",
                  "    // preferredDate and preferredTime should be null/undefined",
                  "    pm.expect(response.sr.preferredDate).to.be.null;",
                  "    pm.expect(response.sr.preferredTime).to.be.null;",
                  "});",
                  "",
                  "pm.test('Original service details preserved', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.sr.category).to.exist;",
                  "    pm.expect(response.sr.subservice).to.exist;",
                  "    pm.expect(response.sr.description).to.exist;",
                  "    pm.expect(response.sr.address).to.exist;",
                  "});",
                  "",
                  "pm.test('isGuest is false for authenticated customer', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.sr.isGuest).to.equal(false);",
                  "});",
                  "",
                  "pm.test('source is CUSTOMER_APP', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.sr.source).to.equal('CUSTOMER_APP');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Reject Service Request",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"reason\": \"Service not available in your area at this time\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/srs/1/reject",
              "host": ["{{base_url}}"],
              "path": ["srs", "1", "reject"]
            },
            "description": "Admin/Dispatcher can reject a service request with a reason. Customer will be notified."
          }
        }
      ]
    },
    {
      "name": "Notifications",
      "item": [
        {
          "name": "Get My Notifications",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/notifications",
              "host": ["{{base_url}}"],
              "path": ["notifications"]
            },
            "description": "Get all notifications for logged-in user with formatted dates and reference IDs"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Response is successful', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response is an array', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.be.an('array');",
                  "});",
                  "",
                  "pm.test('Each notification has required fields', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.length > 0) {",
                  "        response.forEach(notification => {",
                  "            pm.expect(notification).to.have.property('id');",
                  "            pm.expect(notification).to.have.property('title');",
                  "            pm.expect(notification).to.have.property('message');",
                  "            pm.expect(notification).to.have.property('createdAt');",
                  "            pm.expect(notification).to.have.property('createdAtFormatted');",
                  "            pm.expect(notification).to.have.property('isRead');",
                  "            pm.expect(notification).to.have.property('type');",
                  "            pm.expect(notification).to.have.property('referenceId');",
                  "        });",
                  "    }",
                  "});",
                  "",
                  "pm.test('Notification types are valid', function () {",
                  "    const response = pm.response.json();",
                  "    const validTypes = [",
                  "        'SR_CREATED',",
                  "        'SR_ASSIGNED',",
                  "        'SR_COMPLETED',",
                  "        'SR_CANCELLED',",
                  "        'TECH_ON_WAY',",
                  "        'TECH_ARRIVED',",
                  "        'NEW_SR_AVAILABLE',",
                  "        'WO_ASSIGNMENT',",
                  "        'PAYMENT_VERIFIED'",
                  "    ];",
                  "    if (response.length > 0) {",
                  "        response.forEach(notification => {",
                  "            pm.expect(validTypes).to.include(notification.type);",
                  "        });",
                  "    }",
                  "});",
                  "",
                  "pm.test('createdAtFormatted is human readable', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.length > 0) {",
                  "        response.forEach(notification => {",
                  "            pm.expect(notification.createdAtFormatted).to.be.a('string');",
                  "            pm.expect(notification.createdAtFormatted).to.match(/[A-Z][a-z]{2}\\s+\\d{1,2},\\s+\\d{4}/);",
                  "            console.log('Notification:', notification.title, '- Date:', notification.createdAtFormatted);",
                  "        });",
                  "    }",
                  "});",
                  "",
                  "pm.test('referenceId exists for SR-related notifications', function () {",
                  "    const response = pm.response.json();",
                  "    const srNotifications = response.filter(n => n.type.includes('SR_'));",
                  "    if (srNotifications.length > 0) {",
                  "        srNotifications.forEach(notification => {",
                  "            pm.expect(notification.referenceId).to.exist;",
                  "            console.log('SR Notification:', notification.type, '- Reference ID:', notification.referenceId);",
                  "        });",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Unread Notifications Only",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/notifications?unreadOnly=true",
              "host": ["{{base_url}}"],
              "path": ["notifications"],
              "query": [
                {
                  "key": "unreadOnly",
                  "value": "true"
                }
              ]
            },
            "description": "Filter to show only unread notifications"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('All returned notifications are unread', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.length > 0) {",
                  "        response.forEach(notification => {",
                  "            pm.expect(notification.isRead).to.equal(false);",
                  "        });",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Mark Notification as Read",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/notifications/1/read",
              "host": ["{{base_url}}"],
              "path": ["notifications", "1", "read"]
            },
            "description": "Mark a specific notification as read by ID"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Notification marked as read', function () {",
                  "    pm.response.to.have.status(200);",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.isRead).to.equal(true);",
                  "    pm.expect(response.readAt).to.exist;",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Mark All Notifications as Read",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/notifications/read-all",
              "host": ["{{base_url}}"],
              "path": ["notifications", "read-all"]
            },
            "description": "Mark all notifications as read for the logged-in user"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('All notifications marked as read', function () {",
                  "    pm.response.to.have.status(200);",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.message).to.include('marked as read');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Customer Profile",
      "item": [
        {
          "name": "Get My Profile (with stats)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/auth/profile",
              "host": ["{{base_url}}"],
              "path": ["auth", "profile"]
            },
            "description": "Get customer profile with statistics: totalBookings (completed SRs), totalSpent (sum of payments), and businessHours (company hours)."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Response is successful', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Profile includes user details', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('id');",
                  "    pm.expect(response).to.have.property('name');",
                  "    pm.expect(response).to.have.property('phone');",
                  "    pm.expect(response).to.have.property('email');",
                  "    pm.expect(response).to.have.property('role');",
                  "});",
                  "",
                  "pm.test('Profile includes totalBookings (count of completed SRs)', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('totalBookings');",
                  "    pm.expect(response.totalBookings).to.be.a('number');",
                  "    pm.expect(response.totalBookings).to.be.at.least(0);",
                  "    console.log('Total Bookings (Completed SRs):', response.totalBookings);",
                  "});",
                  "",
                  "pm.test('Profile includes totalSpent (sum of verified payments)', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('totalSpent');",
                  "    pm.expect(response.totalSpent).to.be.a('number');",
                  "    pm.expect(response.totalSpent).to.be.at.least(0);",
                  "    console.log('Total Spent:', response.totalSpent);",
                  "});",
                  "",
                  "pm.test('Profile includes businessHours (company settings)', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('businessHours');",
                  "    pm.expect(response.businessHours).to.be.an('object');",
                  "    ",
                  "    // Verify all days are present",
                  "    const daysOfWeek = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];",
                  "    daysOfWeek.forEach(day => {",
                  "        pm.expect(response.businessHours).to.have.property(day);",
                  "        console.log(`${day}: ${response.businessHours[day]}`);",
                  "    });",
                  "});",
                  "",
                  "pm.test('totalBookings logic correct (only PAID_VERIFIED WOs counted)', function () {",
                  "    const response = pm.response.json();",
                  "    // Ensure totalBookings represents completed service requests",
                  "    // A booking is only counted when WO status is PAID_VERIFIED",
                  "    pm.expect(response.totalBookings).to.exist;",
                  "});",
                  "",
                  "pm.test('totalSpent logic correct (only VERIFIED payments counted)', function () {",
                  "    const response = pm.response.json();",
                  "    // Ensure totalSpent only includes verified/paid amounts",
                  "    pm.expect(response.totalSpent).to.exist;",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Update My Profile",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"John Updated\",\n  \"email\": \"john.updated@example.com\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/auth/profile",
              "host": ["{{base_url}}"],
              "path": ["auth", "profile"]
            },
            "description": "Update customer profile (name and email only)"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Profile updated successfully', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Updated fields are returned', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response).to.have.property('name');",
                  "    pm.expect(response).to.have.property('email');",
                  "    pm.expect(response).to.have.property('updatedAt');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Call Center Flow",
      "item": [
        {
          "name": "1. Search Customer by Phone",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/srs/search-customer?phone=9999999999",
              "host": ["{{base_url}}"],
              "path": ["srs", "search-customer"],
              "query": [
                {
                  "key": "phone",
                  "value": "9999999999",
                  "description": "Customer phone number (10-15 digits)"
                }
              ]
            },
            "description": "Step 1: Search for existing customer by phone. Returns customer details if exists."
          }
        },
        {
          "name": "2a. Create SR for Existing Customer",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"9999999999\",\n  \"address\": \"123 Main St, New York\",\n  \"latitude\": 40.7128,\n  \"longitude\": -74.0060,\n  \"categoryId\": 1,\n  \"subserviceId\": 1,\n  \"serviceId\": 1,\n  \"description\": \"AC not cooling properly\",\n  \"priority\": \"HIGH\",\n  \"paymentType\": \"CASH\",\n  \"scheduledAt\": \"2025-12-05T14:00:00Z\",\n  \"preferredTime\": \"Afternoon\",\n  \"notes\": \"Customer prefers technician to call before arrival\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/srs",
              "host": ["{{base_url}}"],
              "path": ["srs"]
            },
            "description": "Step 2a: If customer exists, create SR with their phone. scheduledAt and notes are optional call center fields."
          }
        },
        {
          "name": "2b. Create SR for New Customer",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{auth_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"0123456789\",\n  \"name\": \"John Doe\",\n  \"email\": \"john@example.com\",\n  \"address\": \"456 Oak Ave, Brooklyn\",\n  \"homeAddress\": \"456 Oak Ave, Brooklyn\",\n  \"latitude\": 40.6782,\n  \"longitude\": -73.9442,\n  \"categoryId\": 1,\n  \"subserviceId\": 1,\n  \"serviceId\": 1,\n  \"description\": \"Plumbing leak in kitchen\",\n  \"priority\": \"MEDIUM\",\n  \"paymentType\": \"CASH\",\n  \"scheduledAt\": \"2025-12-05T10:00:00Z\",\n  \"preferredTime\": \"Morning\",\n  \"notes\": \"New customer, verify address on arrival\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/srs",
              "host": ["{{base_url}}"],
              "path": ["srs"]
            },
            "description": "Step 2b: If customer doesn't exist, provide name and email to create new customer account. Call center automatically creates customer and SR."
          }
        }
      ]
    },
    {
      "name": "Registration (OTP Flow)",
      "item": [
        {
          "name": "LEGACY - Complete Registration with OTP",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"phone\": \"0123456789\",\n  \"name\": \"New Customer\",\n  \"email\": \"newcustomer@example.com\",\n  \"otp\": \"123456\",\n  \"password\": \"SecurePass123\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/auth/register",
              "host": ["{{base_url}}"],
              "path": ["auth", "register"]
            },
            "description": "LEGACY: Old registration endpoint (requires OTP + all data in single call). Use new 3-step flow instead."
          }
        }
      ]
    }
  ]
}