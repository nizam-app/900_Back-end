// Prisma 5.x Compatible Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int                 @id @default(autoincrement())
  name                   String?
  phone                  String              @unique
  email                  String?             @unique
  passwordHash           String
  role                   Role
  isBlocked              Boolean             @default(false)
  blockedReason          String?
  blockedAt              DateTime?
  blockedById            Int?
  lastLatitude           Float?
  lastLongitude          Float?
  locationStatus         String?
  locationUpdatedAt      DateTime?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  auditLogs              AuditLog[]
  commissions            Commission[]
  notifications          Notification[]
  otpRecords             OTP[]
  payments               Payment[]           @relation("TechnicianPayment")
  paymentsVerified       Payment[]           @relation("PaymentVerifier")
  createdPayouts         Payout[]            @relation("PayoutCreator")
  payouts                Payout[]
  reviewedPayoutRequests PayoutRequest[]     @relation("PayoutReviewer")
  payoutRequests         PayoutRequest[]
  createdSRs             ServiceRequest[]    @relation("CreatedBySR")
  serviceRequests        ServiceRequest[]    @relation("CustomerSR")
  checkins               TechnicianCheckin[]
  technicianProfile      TechnicianProfile?
  blockedBy              User?               @relation("BlockedByUser", fields: [blockedById], references: [id])
  blockedUsers           User[]              @relation("BlockedByUser")
  wallet                 Wallet?
  walletTransactions     WalletTransaction[]
  workOrders             WorkOrder[]         @relation("CustomerWO")
  dispatchWOs            WorkOrder[]         @relation("DispatcherWO")
  technicianWOs          WorkOrder[]         @relation("TechWO")
}

model TechnicianProfile {
  id             Int       @id @default(autoincrement())
  userId         Int       @unique
  type           TechType
  specialty      Specialty @default(GENERAL)
  commissionRate Float
  bonusRate      Float
  status         String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id])
}

model Category {
  id              Int              @id @default(autoincrement())
  name            String
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  services        Service[]
  serviceRequests ServiceRequest[]
  subservices     Subservice[]
  workOrders      WorkOrder[]
}

model Subservice {
  id              Int              @id @default(autoincrement())
  categoryId      Int
  name            String
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  services        Service[]
  serviceRequests ServiceRequest[]
  category        Category         @relation(fields: [categoryId], references: [id])
  workOrders      WorkOrder[]
}

model Service {
  id              Int              @id @default(autoincrement())
  categoryId      Int
  subserviceId    Int
  name            String
  description     String?
  baseRate        Float?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  category        Category         @relation(fields: [categoryId], references: [id])
  subservice      Subservice       @relation(fields: [subserviceId], references: [id])
  serviceRequests ServiceRequest[]
  workOrders      WorkOrder[]
}

model ServiceRequest {
  id           Int         @id @default(autoincrement())
  srNumber     String      @unique
  customerId   Int
  createdById  Int?
  categoryId   Int
  subserviceId Int
  serviceId    Int?
  description  String?
  priority     String
  address      String
  paymentType  String
  status       String
  source       String
  isGuest      Boolean     @default(false)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  category     Category    @relation(fields: [categoryId], references: [id])
  createdBy    User?       @relation("CreatedBySR", fields: [createdById], references: [id])
  customer     User        @relation("CustomerSR", fields: [customerId], references: [id])
  service      Service?    @relation(fields: [serviceId], references: [id])
  subservice   Subservice  @relation(fields: [subserviceId], references: [id])
  workOrders   WorkOrder[]
}

model WorkOrder {
  id               Int                 @id @default(autoincrement())
  woNumber         String              @unique
  srId             Int
  customerId       Int
  technicianId     Int?
  dispatcherId     Int?
  categoryId       Int
  subserviceId     Int
  serviceId        Int?
  address          String
  paymentType      String
  priority         String
  estimatedHours   Int?
  status           String
  scheduledAt      DateTime?
  acceptedAt       DateTime?
  startedAt        DateTime?
  completedAt      DateTime?
  paidVerifiedAt   DateTime?
  cancelledAt      DateTime?
  cancelReason     String?
  responseDeadline DateTime?
  isExpired        Boolean             @default(false)
  notes            String?
  completionNotes  String?
  completionPhotos String?
  materialsUsed    String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  commissions      Commission[]
  payments         Payment[]
  checkins         TechnicianCheckin[]
  category         Category            @relation(fields: [categoryId], references: [id])
  customer         User                @relation("CustomerWO", fields: [customerId], references: [id])
  dispatcher       User?               @relation("DispatcherWO", fields: [dispatcherId], references: [id])
  service          Service?            @relation(fields: [serviceId], references: [id])
  serviceRequest   ServiceRequest      @relation(fields: [srId], references: [id])
  subservice       Subservice          @relation(fields: [subserviceId], references: [id])
  technician       User?               @relation("TechWO", fields: [technicianId], references: [id])
}

model TechnicianCheckin {
  id           Int       @id @default(autoincrement())
  woId         Int
  technicianId Int
  latitude     Float
  longitude    Float
  createdAt    DateTime  @default(now())
  technician   User      @relation(fields: [technicianId], references: [id])
  workOrder    WorkOrder @relation(fields: [woId], references: [id])
}

model Payment {
  id             Int          @id @default(autoincrement())
  woId           Int
  technicianId   Int?
  amount         Float
  method         String
  transactionRef String?
  proofUrl       String?
  status         String
  verifiedById   Int?
  verifiedAt     DateTime?
  rejectedReason String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  commissions    Commission[]
  technician     User?        @relation("TechnicianPayment", fields: [technicianId], references: [id])
  verifiedBy     User?        @relation("PaymentVerifier", fields: [verifiedById], references: [id])
  workOrder      WorkOrder    @relation(fields: [woId], references: [id])
}

model Wallet {
  id           Int                 @id @default(autoincrement())
  technicianId Int                 @unique
  balance      Float               @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  technician   User                @relation(fields: [technicianId], references: [id])
  transactions WalletTransaction[]
}

model WalletTransaction {
  id           Int      @id @default(autoincrement())
  walletId     Int
  technicianId Int
  type         String
  sourceType   String
  sourceId     Int?
  amount       Float
  description  String?
  createdAt    DateTime @default(now())
  technician   User     @relation(fields: [technicianId], references: [id])
  wallet       Wallet   @relation(fields: [walletId], references: [id])
}

model Commission {
  id           Int       @id @default(autoincrement())
  woId         Int
  technicianId Int
  type         String
  rate         Float
  amount       Float
  status       String
  payoutId     Int?
  paymentId    Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  payment      Payment?  @relation(fields: [paymentId], references: [id])
  payout       Payout?   @relation(fields: [payoutId], references: [id])
  technician   User      @relation(fields: [technicianId], references: [id])
  workOrder    WorkOrder @relation(fields: [woId], references: [id])
}

model PayoutRequest {
  id           Int       @id @default(autoincrement())
  technicianId Int
  amount       Float
  status       String
  reason       String?
  reviewedById Int?
  reviewedAt   DateTime?
  createdAt    DateTime  @default(now())
  reviewedBy   User?     @relation("PayoutReviewer", fields: [reviewedById], references: [id])
  technician   User      @relation(fields: [technicianId], references: [id])
}

model Payout {
  id           Int          @id @default(autoincrement())
  technicianId Int
  totalAmount  Float
  type         String
  status       String
  requestedAt  DateTime?
  processedAt  DateTime?
  createdById  Int?
  createdAt    DateTime     @default(now())
  commissions  Commission[]
  createdBy    User?        @relation("PayoutCreator", fields: [createdById], references: [id])
  technician   User         @relation(fields: [technicianId], references: [id])
}

model Notification {
  id        Int       @id @default(autoincrement())
  userId    Int
  type      String
  title     String
  message   String
  dataJson  String?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])
}

model AuditLog {
  id           Int      @id @default(autoincrement())
  userId       Int?
  action       String
  entityType   String
  entityId     Int?
  metadataJson String?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id])
}

model OTP {
  id        Int      @id @default(autoincrement())
  phone     String
  code      String
  type      String
  isUsed    Boolean  @default(false)
  expiresAt DateTime
  userId    Int?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

enum Role {
  CUSTOMER
  TECH_INTERNAL
  TECH_FREELANCER
  DISPATCHER
  CALL_CENTER
  ADMIN
}

enum TechType {
  INTERNAL
  FREELANCER
}

enum Specialty {
  ELECTRICAL
  PLUMBING
  HVAC
  GENERAL
  CARPENTRY
  PAINTING
}
